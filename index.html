<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>AnimeTosho Subtitles Search (Fast)</title>
  <script src="https://cdn.jsdelivr.net/npm/picklejs@1.0.2/dist/pickle.min.js"></script> <!-- For pickle loading -->
  <style>
    body { font-family: Arial; max-width: 1000px; margin: 40px auto; padding: 20px; }
    input, select, button { padding: 10px; font-size: 16px; margin: 5px; }
    #filters { display: flex; flex-wrap: wrap; gap: 10px; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    th { background: #f0f0f0; }
    #status { margin: 20px 0; font-weight: bold; }
    a { color: blue; }
  </style>
</head>
<body>
  <h1>AnimeTosho Extracted Subtitles/Fonts Search</h1>
  <p>Daily updated • Search by Nyaa ID, name, language, etc. • Direct download links</p>

  <div id="filters">
    <input type="text" id="nyaaId" placeholder="Nyaa Torrent ID (e.g., 1810173)" />
    <input type="text" id="animeName" placeholder="Anime name" />
    <select id="language">
      <option value="">All Languages</option>
      <!-- Filled dynamically -->
    </select>
    <input type="text" id="episode" placeholder="Episode (e.g., 13)" />
    <input type="text" id="group" placeholder="Release group" />
    <button onclick="search()">Search</button>
  </div>

  <div id="status">Loading index (first time ~10-20s)...</div>
  <div id="results"></div>

  <script>
    let db = null;
    let languages = [];

    async function loadIndex() {
      if (db) return;
      const status = document.getElementById('status');
      status.textContent = 'Downloading latest subtitles index (~50-80 MB compressed)...';
      const resp = await fetch('data/subtitles_index.pkl.gz');
      const arrayBuffer = await resp.arrayBuffer();
      status.textContent = 'Decompressing & parsing...';
      const pickleData = await Pickle.load(arrayBuffer); // picklejs handles gzip
      db = pickleData;
      languages = db.all_languages || [];
      const langSelect = document.getElementById('language');
      languages.forEach(lang => {
        const opt = document.createElement('option');
        opt.value = lang;
        opt.textContent = lang.toUpperCase();
        langSelect.appendChild(opt);
      });
      status.textContent = 'Index loaded! Ready to search.';
    }

    async function search() {
      await loadIndex();
      const nyaaId = document.getElementById('nyaaId').value.trim();
      const name = document.getElementById('animeName').value.toLowerCase();
      const lang = document.getElementById('language').value;
      const ep = document.getElementById('episode').value.trim();
      const group = document.getElementById('group').value.toLowerCase();

      const results = [];
      for (const [file_id, sub_list] of Object.entries(db.subtitles_only)) {
        const [torrent_id, filename] = db.files[file_id] || ['', ''];
        const torrent_name = db.torrents[torrent_id] || '';

        if (nyaaId && torrent_id !== nyaaId) continue;
        if (name && !torrent_name.toLowerCase().includes(name) && !filename.toLowerCase().includes(name)) continue;
        if (group && !torrent_name.toLowerCase().includes(group)) continue;
        if (ep && !filename.includes(ep.padStart(2, '0')) && !filename.includes(` ${ep} `)) continue;

        let matched_subs = sub_list;
        if (lang) matched_subs = sub_list.filter(s => s.lang === lang);

        if (matched_subs.length > 0) {
          results.push({
            torrent_id,
            torrent_name,
            filename,
            subs: matched_subs
          });
        }
      }

      displayResults(results);
    }

    function displayResults(results) {
      const div = document.getElementById('results');
      if (results.length === 0) {
        div.innerHTML = '<p>No matching subtitles/fonts found.</p>';
        return;
      }

      let html = `<p>Found ${results.length} file(s) with subtitles:</p><table><thead><tr><th>Torrent ID</th><th>Torrent Name</th><th>File</th><th>Subtitles</th><th>Download Links</th></tr></thead><tbody>`;
      results.forEach(r => {
        html += `<tr><td>${r.torrent_id}</td><td>${r.torrent_name}</td><td>${r.filename}</td><td>`;
        r.subs.forEach(s => {
          const hex = Number(s.afid).toString(16).padStart(8, '0');
          const url = `https://storage.animetosho.org/attach/${hex}/file.xz`;
          html += `${s.lang.toUpperCase()} (${s.codec}) <a href="${url}" target="_blank">Download</a><br>`;
        });
        const packUrl = `https://animetosho.org/storage/torattachpk/${r.torrent_id}/${encodeURIComponent(r.torrent_name)}_attachments.7z`;
        html += `</td><td><a href="${packUrl}" target="_blank">Full Pack (7z)</a></td></tr>`;
      });
      html += '</tbody></table>';
      div.innerHTML = html;
    }

    // Auto-load on page open
    loadIndex();
  </script>
</body>
</html>
